<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Noah Kessler" />

<meta name="date" content="2020-06-11" />

<title>Structure of murine IAP elements</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>

<link rel="icon" href="https://github.com/workflowr/workflowr-assets/raw/master/img/reproducible.png">
<!-- Add a small amount of space between sections. -->
<style type="text/css">
div.section {
  padding-top: 12px;
}
</style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Genomic Context of Variably-Methylated Repeats</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="about.html">About</a>
</li>
<li>
  <a href="license.html">License</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Structure of murine IAP elements</h1>
<h4 class="author">Noah Kessler</h4>
<h4 class="date">2020-06-11</h4>

</div>


<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-report" data-toggle="collapse" data-target="#workflowr-report">
<span class="glyphicon glyphicon-list" aria-hidden="true"></span> workflowr <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span>
</button>
</p>
<div id="workflowr-report" class="collapse">
<ul class="nav nav-tabs">
<li class="active">
<a data-toggle="tab" href="#summary">Summary</a>
</li>
<li>
<a data-toggle="tab" href="#checks"> Checks <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span> </a>
</li>
<li>
<a data-toggle="tab" href="#versions">Past versions</a>
</li>
</ul>
<div class="tab-content">
<div id="summary" class="tab-pane fade in active">
<p>
<strong>Last updated:</strong> 2020-06-11
</p>
<p>
<strong>Checks:</strong> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> 6 <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span> 1
</p>
<p>
<strong>Knit directory:</strong> <code>Paper_VMIAP_2020/</code> <span class="glyphicon glyphicon-question-sign" aria-hidden="true" title="This is the local directory in which the code in this file was executed."> </span>
</p>
<p>
This reproducible <a href="http://rmarkdown.rstudio.com">R Markdown</a> analysis was created with <a
  href="https://github.com/jdblischak/workflowr">workflowr</a> (version 1.6.2). The <em>Checks</em> tab describes the reproducibility checks that were applied when the results were created. The <em>Past versions</em> tab lists the development history.
</p>
<hr>
</div>
<div id="checks" class="tab-pane fade">
<div id="workflowr-checks" class="panel-group">
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRMarkdownfilestronguptodate"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>R Markdown file:</strong> up-to-date </a>
</p>
</div>
<div id="strongRMarkdownfilestronguptodate" class="panel-collapse collapse">
<div class="panel-body">
<p>Great! Since the R Markdown file has been committed to the Git repository, you know the exact version of the code that produced these results.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongEnvironmentstrongempty"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Environment:</strong> empty </a>
</p>
</div>
<div id="strongEnvironmentstrongempty" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! The global environment was empty. Objects defined in the global environment can affect the analysis in your R Markdown file in unknown ways. For reproduciblity it’s best to always run the code in an empty environment.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSeedstrongcodesetseed20200511code"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Seed:</strong> <code>set.seed(20200511)</code> </a>
</p>
</div>
<div id="strongSeedstrongcodesetseed20200511code" class="panel-collapse collapse">
<div class="panel-body">
<p>The command <code>set.seed(20200511)</code> was run prior to running the code in the R Markdown file. Setting a seed ensures that any results that rely on randomness, e.g. subsampling or permutations, are reproducible.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongSessioninformationstrongrecorded"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Session information:</strong> recorded </a>
</p>
</div>
<div id="strongSessioninformationstrongrecorded" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Recording the operating system, R version, and package versions is critical for reproducibility.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongCachestrongdetected"> <span class="glyphicon glyphicon-exclamation-sign text-danger" aria-hidden="true"></span> <strong>Cache:</strong> detected </a>
</p>
</div>
<div id="strongCachestrongdetected" class="panel-collapse collapse">
<div class="panel-body">
The following chunks had caches available:
<ul>
<li>
fix.partial.IAPs
</li>
<li>
load.IAP.data
</li>
<li>
refine.IAP.structure
</li>
</ul>
<p>To ensure reproducibility of the results, delete the cache directory <code>01.IAP_Annotations_cache</code> and re-run the analysis. To have workflowr automatically delete the cache directory prior to building the file, set <code>delete_cache = TRUE</code> when running <code>wflow_build()</code> or <code>wflow_publish()</code>.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongFilepathsstrongrelative"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>File paths:</strong> relative </a>
</p>
</div>
<div id="strongFilepathsstrongrelative" class="panel-collapse collapse">
<div class="panel-body">
<p>Great job! Using relative paths to the files within your workflowr project makes it easier to run your code on other machines.</p>
</div>
</div>
</div>
<div class="panel panel-default">
<div class="panel-heading">
<p class="panel-title">
<a data-toggle="collapse" data-parent="#workflowr-checks" href="#strongRepositoryversionstrongb5e4f02"> <span class="glyphicon glyphicon-ok text-success" aria-hidden="true"></span> <strong>Repository version:</strong> b5e4f02 </a>
</p>
</div>
<div id="strongRepositoryversionstrongb5e4f02" class="panel-collapse collapse">
<div class="panel-body">
<p>
Great! You are using Git for version control. Tracking code development and connecting the code version to the results is critical for reproducibility.
</p>
<p>
The results in this page were generated with repository version b5e4f02. See the <em>Past versions</em> tab to see a history of the changes made to the R Markdown and HTML files.
</p>
<p>
Note that you need to be careful to ensure that all relevant files for the analysis have been committed to Git prior to generating the results (you can use <code>wflow_publish</code> or <code>wflow_git_commit</code>). workflowr only checks the R Markdown file, but you know if there are other scripts or data files that it depends on. Below is the status of the Git repository when the results were generated:
</p>
<pre><code>
Ignored files:
    Ignored:    analysis/01.IAP_Annotations_cache/

Untracked files:
    Untracked:  01.IAP_Annotations.Rmd
    Untracked:  __pycache__/
    Untracked:  analysis/02.Screen_for_VM_IAP.Rmd
    Untracked:  analysis/fix_RepeatMasker_breaks.py
    Untracked:  code/CTCFChIPatVM-IAPs_narrowpeak.sh
    Untracked:  code/CTCFChIPatVM-IAPs_pvalueRelax_narrowpeak.sh
    Untracked:  code/CTCF_Analysis.Rmd
    Untracked:  code/CTCF_motif_in_IAP.Rmd
    Untracked:  code/CpGdensity_VM-IAPs.R
    Untracked:  code/combine_8Indiv_CTCFChIP.r
    Untracked:  code/combine_8Indiv_CTCFChIP_pvalueRelax.r
    Untracked:  code/demultiplex4C_5indiv.sh
    Untracked:  code/heatmaps_NJK.R
    Untracked:  code/map.commands_cp.sh
    Untracked:  code/mergeBam
    Untracked:  code/normalize_log2.sh
    Untracked:  code/normalize_log2_IAP_consensus.sh
    Untracked:  code/normalize_log2_mergedBams.sh
    Untracked:  code/plot_chip_in_iap.R
    Untracked:  code/run_fimo_top10percent.sh
    Untracked:  code/run_meme_top_10_percent.sh
    Untracked:  data/R_objects/
    Untracked:  data/misc/Schema_for_rmskOutCurrent.html
    Untracked:  data/repeat_annotations/
    Untracked:  utils/

Unstaged changes:
    Deleted:    data/misc/example_broken_IAP.PNG

</code></pre>
<p>
Note that any generated files, e.g. HTML, png, CSS, etc., are not included in this status report because it is ok for generated content to have uncommitted changes.
</p>
</div>
</div>
</div>
</div>
<hr>
</div>
<div id="versions" class="tab-pane fade">

<p>
These are the previous versions of the repository in which changes were made to the R Markdown (<code>analysis/01.IAP_Annotations.Rmd</code>) and HTML (<code>docs/01.IAP_Annotations.html</code>) files. If you’ve configured a remote Git repository (see <code>?wflow_git_remote</code>), click on the hyperlinks in the table below to view the files as they were in that past version.
</p>
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
File
</th>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
<th>
Message
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
Rmd
</td>
<td>
f08eee0
</td>
<td>
Noah Kessler
</td>
<td>
2020-06-11
</td>
<td>
wflow_git_commit(“analysis/01.IAP_Annotations.Rmd”)
</td>
</tr>
<tr>
<td>
html
</td>
<td>
10feacb
</td>
<td>
Noah Kessler
</td>
<td>
2020-05-12
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
47ffee2
</td>
<td>
Noah Kessler
</td>
<td>
2020-05-12
</td>
<td>
Small text changes
</td>
</tr>
<tr>
<td>
html
</td>
<td>
29299e4
</td>
<td>
Noah Kessler
</td>
<td>
2020-05-11
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
776aef8
</td>
<td>
Noah Kessler
</td>
<td>
2020-05-11
</td>
<td>
Re-publishing annot with autodep=TRUE
</td>
</tr>
<tr>
<td>
html
</td>
<td>
0e982a4
</td>
<td>
Noah Kessler
</td>
<td>
2020-05-11
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
9ef3242
</td>
<td>
Noah Kessler
</td>
<td>
2020-05-11
</td>
<td>
Re-publishing annot analysis, last changes didn’t take (?)
</td>
</tr>
<tr>
<td>
html
</td>
<td>
e4b9905
</td>
<td>
Noah Kessler
</td>
<td>
2020-05-11
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
html
</td>
<td>
6b0583c
</td>
<td>
Noah Kessler
</td>
<td>
2020-05-11
</td>
<td>
Build site.
</td>
</tr>
<tr>
<td>
Rmd
</td>
<td>
5d84988
</td>
<td>
Noah Kessler
</td>
<td>
2020-05-11
</td>
<td>
wflow_publish(“analysis/01.*.Rmd“, delete_cache = TRUE)
</td>
</tr>
</tbody>
</table>
</div>
<hr>
</div>
</div>
</div>
<div id="background" class="section level1">
<h1>Background</h1>
<div id="iap-annotation-reference" class="section level2">
<h2>IAP annotation reference</h2>
<p>Using the data from Dfam underlying the RepeatMasker Viz. track on the UCSC genome browser (<a href="https://genome-euro.ucsc.edu/cgi-bin/hgTrackUi?hgsid=231012898_CuPwusZaPALPWqM8IKvFe2w64gNC&amp;g=joinedRmsk">description</a>), here I will characterise the structure of murine IAP elements in terms of IAP-subelements present at each annotated IAP locus. This dataset contains information about how ‘complete’ the subelements are relative to their reference, and how several subelements combine to form one ‘full’ IAP.</p>
<p>The annotation used in this analysis is the <a href="http://hgdownload.soe.ucsc.edu/goldenPath/mm10/database/rmskOutCurrent.txt.gz">rmskOutCurrent file from the UCSC SQL table dump annotations page</a>, dated 2018-10-28.</p>
<pre class="r"><code>annot_dir &lt;- &quot;data/repeat_annotations&quot;

# NB: The downloaded file has been renamed with the UCSC and Dfam version numbers;
# these may be edited as necessary, or ignored altogether (using the line below)
#rmsk_full &lt;- file.path(annot_dir, &quot;rmskOutCurrent.txt.gz&quot;)
rmsk_full &lt;- file.path(annot_dir, &quot;rmskOutCurrent.Dfam_2_0.v4_0_7.txt.gz&quot;)
rmsk_iap_orig &lt;- paste0(tools::file_path_sans_ext(rmsk_full, TRUE), &quot;.all_IAPs.txt.gz&quot;)

break_fix_seq_gap &lt;- 20
break_fix_rep_gap &lt;- 20
rmsk_iap_break_fix &lt;- sprintf(&quot;%s.fixed_500kb_s_%d_r_%d.tsv.gz&quot;, tools::file_path_sans_ext(rmsk_iap_orig, TRUE), break_fix_seq_gap, break_fix_rep_gap)

run_rmsk_fix = params$force_rmsk || !file.exists(rmsk_iap_break_fix)</code></pre>
<p>The RepeatMasker annotation contains every type of repetitive element and has breaks every 500kb. The first steps in this analysis will be to subset the annotation so that it only contains IAP elements, and to fix the 500kb breaks.</p>
<pre class="python"><code># rmskOutCurrent format:
# bin swScore milliDev milliDel milliIns genoName genoStart genoEnd genoLeft strand repName repClass repFamily repStart repEnd repLeft id
#
# data schema: https://genome-euro.ucsc.edu/cgi-bin/hgTables?hgsid=231014018_roJ2Iz2tmhdVWs4k5HUSxPurFQ2r&amp;hgta_doSchemaDb=mm10&amp;hgta_doSchemaTable=rmskOutCurrent
# cached version of schema: data/misc/Schema_for_rmskOutCurrent.html
import gzip
from fix_RepeatMasker_breaks import fix_RM_breaks

# get id&#39;s of all elements containing an IAP
IAP_ids = set()
with gzip.open(r.rmsk_full, &#39;rt&#39;) as rmskf:
  for line in rmskf:
    tokens = line.rstrip(&#39;\n&#39;).split(&#39;\t&#39;)
    if tokens[10].startswith(&#39;IAP&#39;) and tokens[11] == &#39;LTR&#39; and tokens[12] == &#39;ERVK&#39;:
      IAP_ids.add(int(tokens[16]))

# read back through file, saving all entries from IAP elements
with gzip.open(r.rmsk_full, &#39;rt&#39;) as rmskf, gzip.open(r.rmsk_iap_orig, &#39;wt&#39;) as iapf:
  for line in rmskf:
    if int(line.rstrip(&#39;\n&#39;).split(&#39;\t&#39;)[16]) in IAP_ids:
      _ = iapf.write(line) # capture return value to avoid printing to stdout

# fix 500kb breaks in annotations
fix_RM_breaks(r.rmsk_iap_orig, seq_gap=r.break_fix_seq_gap, rep_gap=r.break_fix_rep_gap, outfile=r.rmsk_iap_break_fix)</code></pre>
<pre class="r"><code># note: start coords are 0-based
mm10.IAP &lt;- read.table(rmsk_iap_break_fix)
colnames(mm10.IAP) &lt;- c(&quot;chrom&quot;, &quot;start&quot;, &quot;end&quot;, &quot;strand&quot;, &quot;repName&quot;, &quot;repClass&quot;, &quot;repFamily&quot;, &quot;repStart&quot;, &quot;repEnd&quot;, &quot;element.ID&quot;)
mm10.IAP.gr &lt;- with(mm10.IAP, GRanges(chrom, IRanges(start, end), strand=strand))
mcols(mm10.IAP.gr) &lt;- mm10.IAP[,-c(1:4)]</code></pre>
<p>After these steps, there are 30567 IAP (sub)element entries, representing 13065 IAP elements. These elements are made up of 49 IAP subelement types: <em>IAPLTR1a_Mm, IAPEY2_LTR, IAPEy-int, IAPEY3_LTR, IAPLTR2b, IAPLTR2_Mm, IAPEz-int, IAPEY4_I-int, IAP-d-int, IAPEY3-int, RLTR10B2, IAP1-MM_I-int, IAP1-MM_LTR, IAPLTR2a2_Mm, IAPLTR4, IAPLTR1_Mm, IAPEY3C_LTR, IAPLTR4_I, IAPLTR3, IAPLTR3-int, RLTR10-int, RLTR10F, IAPLTR2a, IAPEY5_LTR, IAPEY5_I-int, RLTR10D, IAPEY_LTR, RMER6C, MMERVK10C-int, IAPEY4_LTR, RLTR10A, RLTR10C, RLTR46A, ETnERV3-int, ETnERV-int, RLTR10, IAPA_MM-int, RLTR10E, RLTR46A2, ERVB4_3-LTR_MM, RLTR27, RLTR46B, RLTR10B, RLTR46, RLTR10D2, RLTR9A3, LTR10_RN, RMER17C, RMER16-int</em>.</p>
<p>Within an IAP, the subelements may be missing components (relative to their full-length reference), or be broken up by other retroelements that have inserted themselves within the element. Note that many of the subelements which appear multiple times in the same IAP are often actually fragmented parts of a full subelement.</p>
</div>
</div>
<div id="refining-structure" class="section level1">
<h1>Refining structure</h1>
<p>Initially I tried to overcome this by merging adjacent subelements which were broken up in the annotation, requiring the broken subelements to have be an exact continuation of the IAP subelement reference (i.e., the repEnd of on element corresponding to repStart of the next). However this was extremely slow and didn’t produced the desired results.</p>
<pre class="r"><code>get.reduced.structure &lt;- function(strand, repName) {
  paste(
    {if (any(strand==&quot;-&quot;)) rev(repName[start(Rle(repName))]) else repName[start(Rle(repName))]},
    collapse=&quot;|&quot;
  )
}

mm10.IAP.reduced &lt;- mm10.IAP.gr %&gt;% as.data.frame() %&gt;%
  group_by(element.ID, strand) %&gt;% # sublements should all be on the same strand
  summarize(reduced.structure=get.reduced.structure(strand, repName))

mm10.IAP.reduced.counts &lt;- count.df(mm10.IAP.reduced, &quot;reduced.structure&quot;, &quot;Genome&quot;)</code></pre>
<p>A faster and more digestible solution was to simply ‘collapse’ adjacent subelements of the same type into a single subelement of that type (e.g., <code>IAPLTR1a_Mm|IAPEz-int|IAPEz-int|IAPLTR1a_Mm</code> becomes <code>IAPLTR1a_Mm|IAPEz-int|IAPLTR1a_Mm</code>). This results in 203 unique IAP element structures, shown below with their frequency in the genome:</p>
<div style="border: 1px solid #ddd; padding: 0px; overflow-y: scroll; height:240px; ">
<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;position: sticky; top:0; background-color: #FFFFFF;">
Structure
</th>
<th style="text-align:right;position: sticky; top:0; background-color: #FFFFFF;">
Genome
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
EY2_LTR
</td>
<td style="text-align:right;">
715
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2b
</td>
<td style="text-align:right;">
678
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2a2_Mm
</td>
<td style="text-align:right;">
675
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR1a_Mm || Ez-int || LTR1a_Mm
</td>
<td style="text-align:right;">
666
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR1_Mm || Ez-int || LTR1_Mm
</td>
<td style="text-align:right;">
625
</td>
</tr>
<tr>
<td style="text-align:left;">
EY_LTR
</td>
<td style="text-align:right;">
561
</td>
</tr>
<tr>
<td style="text-align:left;">
d-int
</td>
<td style="text-align:right;">
555
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2_Mm
</td>
<td style="text-align:right;">
531
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR4
</td>
<td style="text-align:right;">
453
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2a
</td>
<td style="text-align:right;">
413
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3-int
</td>
<td style="text-align:right;">
407
</td>
</tr>
<tr>
<td style="text-align:left;">
EY4_I-int
</td>
<td style="text-align:right;">
407
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR3 || LTR3-int
</td>
<td style="text-align:right;">
404
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3C_LTR
</td>
<td style="text-align:right;">
348
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3_LTR
</td>
<td style="text-align:right;">
346
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2a2_Mm || Ez-int || LTR2a2_Mm
</td>
<td style="text-align:right;">
317
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR3-int || LTR3
</td>
<td style="text-align:right;">
256
</td>
</tr>
<tr>
<td style="text-align:left;">
EY_LTR || Ey-int || EY_LTR
</td>
<td style="text-align:right;">
236
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR1a_Mm
</td>
<td style="text-align:right;">
234
</td>
</tr>
<tr>
<td style="text-align:left;">
EY_LTR || EY3-int
</td>
<td style="text-align:right;">
229
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2_Mm || Ez-int || LTR2_Mm
</td>
<td style="text-align:right;">
213
</td>
</tr>
<tr>
<td style="text-align:left;">
1-MM_LTR
</td>
<td style="text-align:right;">
193
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2b || Ez-int || LTR2b
</td>
<td style="text-align:right;">
158
</td>
</tr>
<tr>
<td style="text-align:left;">
EY5_LTR
</td>
<td style="text-align:right;">
141
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR4_I
</td>
<td style="text-align:right;">
138
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || LTR1a_Mm
</td>
<td style="text-align:right;">
125
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || LTR2_Mm
</td>
<td style="text-align:right;">
124
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR1_Mm
</td>
<td style="text-align:right;">
124
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2_Mm || Ez-int
</td>
<td style="text-align:right;">
117
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR3
</td>
<td style="text-align:right;">
110
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2a || Ez-int || LTR2a
</td>
<td style="text-align:right;">
106
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR1a_Mm || Ez-int
</td>
<td style="text-align:right;">
103
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int
</td>
<td style="text-align:right;">
102
</td>
</tr>
<tr>
<td style="text-align:left;">
EY_LTR || Ey-int
</td>
<td style="text-align:right;">
96
</td>
</tr>
<tr>
<td style="text-align:left;">
1-MM_I-int
</td>
<td style="text-align:right;">
92
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR3 || LTR3-int || LTR3
</td>
<td style="text-align:right;">
92
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR3-int || LTR4
</td>
<td style="text-align:right;">
85
</td>
</tr>
<tr>
<td style="text-align:left;">
1-MM_LTR || 1-MM_I-int || 1-MM_LTR
</td>
<td style="text-align:right;">
78
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2a2_Mm || Ez-int
</td>
<td style="text-align:right;">
75
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || LTR2a2_Mm
</td>
<td style="text-align:right;">
70
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR4 || LTR3-int
</td>
<td style="text-align:right;">
70
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10D || d-int || RLTR10D
</td>
<td style="text-align:right;">
66
</td>
</tr>
<tr>
<td style="text-align:left;">
Ey-int || EY2_LTR
</td>
<td style="text-align:right;">
63
</td>
</tr>
<tr>
<td style="text-align:left;">
EY2_LTR || EY3-int
</td>
<td style="text-align:right;">
60
</td>
</tr>
<tr>
<td style="text-align:left;">
EY4_LTR
</td>
<td style="text-align:right;">
56
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || LTR1_Mm
</td>
<td style="text-align:right;">
56
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || LTR2b
</td>
<td style="text-align:right;">
56
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3-int || EY2_LTR
</td>
<td style="text-align:right;">
52
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3C_LTR || MMERVK10C-int
</td>
<td style="text-align:right;">
52
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3-int || RLTR10B2
</td>
<td style="text-align:right;">
50
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3_LTR || EY3-int || EY3_LTR
</td>
<td style="text-align:right;">
47
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || LTR2a
</td>
<td style="text-align:right;">
47
</td>
</tr>
<tr>
<td style="text-align:left;">
EY2_LTR || EY3-int || EY2_LTR
</td>
<td style="text-align:right;">
46
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3-int || EY3_LTR
</td>
<td style="text-align:right;">
45
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2b || Ez-int
</td>
<td style="text-align:right;">
45
</td>
</tr>
<tr>
<td style="text-align:left;">
d-int || RLTR10D
</td>
<td style="text-align:right;">
43
</td>
</tr>
<tr>
<td style="text-align:left;">
Ey-int || EY_LTR
</td>
<td style="text-align:right;">
39
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR3-int
</td>
<td style="text-align:right;">
36
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR1_Mm || Ez-int
</td>
<td style="text-align:right;">
35
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10A || d-int
</td>
<td style="text-align:right;">
31
</td>
</tr>
<tr>
<td style="text-align:left;">
1-MM_LTR || 1-MM_I-int
</td>
<td style="text-align:right;">
30
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3_LTR || EY3-int
</td>
<td style="text-align:right;">
30
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2a || Ez-int
</td>
<td style="text-align:right;">
29
</td>
</tr>
<tr>
<td style="text-align:left;">
1-MM_I-int || EY3C_LTR
</td>
<td style="text-align:right;">
24
</td>
</tr>
<tr>
<td style="text-align:left;">
Ey-int
</td>
<td style="text-align:right;">
24
</td>
</tr>
<tr>
<td style="text-align:left;">
1-MM_I-int || 1-MM_LTR
</td>
<td style="text-align:right;">
22
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3-int || RLTR10F
</td>
<td style="text-align:right;">
21
</td>
</tr>
<tr>
<td style="text-align:left;">
EY5_I-int
</td>
<td style="text-align:right;">
21
</td>
</tr>
<tr>
<td style="text-align:left;">
EY5_LTR || EY5_I-int || EY5_LTR
</td>
<td style="text-align:right;">
20
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR46A || EY5_I-int
</td>
<td style="text-align:right;">
20
</td>
</tr>
<tr>
<td style="text-align:left;">
EY5_LTR || EY5_I-int
</td>
<td style="text-align:right;">
19
</td>
</tr>
<tr>
<td style="text-align:left;">
EY2_LTR || Ey-int
</td>
<td style="text-align:right;">
18
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10D || d-int
</td>
<td style="text-align:right;">
18
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR3-int || LTR2b
</td>
<td style="text-align:right;">
17
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3-int || EY3C_LTR
</td>
<td style="text-align:right;">
16
</td>
</tr>
<tr>
<td style="text-align:left;">
ETnERV3-int || LTR4
</td>
<td style="text-align:right;">
14
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3C_LTR || EY3-int
</td>
<td style="text-align:right;">
14
</td>
</tr>
<tr>
<td style="text-align:left;">
EY4_LTR || EY4_I-int || EY4_LTR
</td>
<td style="text-align:right;">
14
</td>
</tr>
<tr>
<td style="text-align:left;">
EY5_I-int || EY5_LTR
</td>
<td style="text-align:right;">
13
</td>
</tr>
<tr>
<td style="text-align:left;">
EY2_LTR || Ey-int || EY2_LTR
</td>
<td style="text-align:right;">
11
</td>
</tr>
<tr>
<td style="text-align:left;">
EY4_I-int || EY2_LTR
</td>
<td style="text-align:right;">
11
</td>
</tr>
<tr>
<td style="text-align:left;">
EY4_I-int || EY4_LTR
</td>
<td style="text-align:right;">
11
</td>
</tr>
<tr>
<td style="text-align:left;">
1-MM_I-int || EY3_LTR
</td>
<td style="text-align:right;">
10
</td>
</tr>
<tr>
<td style="text-align:left;">
Ey-int || EY3_LTR
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2a2_Mm || RLTR10-int
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR4_I || EY3-int
</td>
<td style="text-align:right;">
8
</td>
</tr>
<tr>
<td style="text-align:left;">
EY4_I-int || LTR4
</td>
<td style="text-align:right;">
7
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || EY3C_LTR
</td>
<td style="text-align:right;">
7
</td>
</tr>
<tr>
<td style="text-align:left;">
d-int || EY3C_LTR
</td>
<td style="text-align:right;">
6
</td>
</tr>
<tr>
<td style="text-align:left;">
d-int || RLTR27
</td>
<td style="text-align:right;">
6
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || EY3_LTR
</td>
<td style="text-align:right;">
6
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR4_I || EY3-int || LTR4_I
</td>
<td style="text-align:right;">
6
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR4 || LTR3-int || LTR4
</td>
<td style="text-align:right;">
6
</td>
</tr>
<tr>
<td style="text-align:left;">
EY5_LTR || EY4_I-int || EY5_LTR
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10F || EY3-int || RLTR10F
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR46A2 || EY4_I-int
</td>
<td style="text-align:right;">
5
</td>
</tr>
<tr>
<td style="text-align:left;">
1-MM_I-int || EY5_LTR
</td>
<td style="text-align:right;">
4
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3-int || RLTR10B
</td>
<td style="text-align:right;">
4
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3-int || RLTR10C
</td>
<td style="text-align:right;">
4
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || LTR2a2_Mm || Ez-int
</td>
<td style="text-align:right;">
4
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR1a_Mm || Ez-int || LTR1a_Mm || Ez-int || LTR1a_Mm
</td>
<td style="text-align:right;">
4
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR4_I || Ey-int
</td>
<td style="text-align:right;">
4
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10 || Ez-int || RLTR10
</td>
<td style="text-align:right;">
4
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR46B || EY4_I-int
</td>
<td style="text-align:right;">
4
</td>
</tr>
<tr>
<td style="text-align:left;">
EY4_I-int || RLTR46B
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || LTR1a_Mm || Ez-int
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || LTR2_Mm || Ez-int
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || RLTR46A2
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR1_Mm || A_MM-int
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2b || EY3-int
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10 || Ez-int
</td>
<td style="text-align:right;">
3
</td>
</tr>
<tr>
<td style="text-align:left;">
1-MM_I-int || RLTR10A
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
EY2_LTR || Ez-int
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3-int || EY5_LTR
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3-int || RLTR10B2 || EY3-int
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
EY5_LTR || EY3-int || EY5_LTR
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || LTR4_I
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2_Mm || Ez-int || LTR2_Mm || Ez-int
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2_Mm || RLTR10-int
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2a || A_MM-int
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2a2_Mm || MMERVK10C-int
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2a2_Mm || RLTR10-int || LTR2a2_Mm
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR4 || EY4_I-int || LTR4
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
MMERVK10C-int || EY2_LTR
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
MMERVK10C-int || EY3_LTR
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR46A || EY3-int
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR46A || EY4_I-int
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR46A2 || EY3-int
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:left;">
ETnERV-int || EY3_LTR
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
ETnERV-int || LTR2a2_Mm
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
d-int || EY5_LTR
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
d-int || LTR10_RN
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
d-int || RLTR10A
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
d-int || RLTR9A3
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
1-MM_I-int || 1-MM_LTR || 1-MM_I-int || 1-MM_LTR
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
1-MM_I-int || RLTR46A2
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
1-MM_LTR || EY3-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
A_MM-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
EY2_LTR || Ez-int || EY2_LTR
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3_LTR || Ey-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3_LTR || Ey-int || EY3_LTR
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3_LTR || EY5_I-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3-int || ERVB4_3-LTR_MM
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3-int || EY_LTR
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3-int || LTR4
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3-int || RLTR10E
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3-int || RLTR46
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3-int || RLTR46A
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3-int || RMER17C
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3C_LTR || EY3-int || EY3C_LTR
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
EY3C_LTR || RLTR10-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
EY4_I-int || RLTR10B
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
EY5_I-int || RLTR10B2
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
EY5_I-int || RLTR10C
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
EY5_LTR || MMERVK10C-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || EY5_LTR
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || LTR1_Mm || Ez-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || LTR2_Mm || Ez-int || LTR2_Mm
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || LTR2a2_Mm || Ez-int || LTR2a2_Mm
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || LTR2b || Ez-int || LTR2b
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
Ez-int || RLTR10 || Ez-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR1a_Mm || A_MM-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR1a_Mm || RLTR10-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR1a_Mm || RLTR10-int || LTR1a_Mm
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2_Mm || A_MM-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2_Mm || Ez-int || LTR2_Mm || Ez-int || LTR2_Mm || Ez-int || LTR2_Mm || Ez-int || LTR2_Mm
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2a2_Mm || A_MM-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2a2_Mm || Ez-int || LTR2a2_Mm || Ez-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2a2_Mm || Ez-int || LTR2a2_Mm || Ez-int || LTR2a2_Mm
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2a2_Mm || RMER16-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2b || A_MM-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2b || Ey-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2b || LTR3-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR2b || RLTR10-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR3-int || LTR2a2_Mm
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR3-int || LTR3 || LTR3-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR3-int || LTR3 || LTR3-int || LTR3
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR3-int || LTR4_I || LTR3-int || LTR4_I
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR4_I || Ez-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR4_I || MMERVK10C-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
LTR4 || MMERVK10C-int || LTR4
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
MMERVK10C-int || EY3C_LTR
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10-int || LTR1a_Mm || RLTR10-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10-int || LTR2b
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10 || d-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10 || Ez-int || RLTR10 || Ez-int || RLTR10
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10A || d-int || RLTR10A
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10A || 1-MM_I-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10B2 || EY3-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10B2 || EY3-int || RLTR10B2
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10D2 || LTR3-int || RLTR10D2
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10E || EY3-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10F || EY3-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR10F || EY5_I-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR46 || EY3-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR46 || EY3-int || RLTR46
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR46 || EY4_I-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR46 || EY4_I-int || RLTR46
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR46 || EY5_I-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR46 || LTR3-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR46A2 || EY4_I-int || RLTR46A2
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RLTR46B || EY4_I-int || RLTR46B
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
RMER6C || EY3-int
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
</div>
<p><em>NB: in the list above and plot below, element names are missing the ‘IAP’ prefix for brevity</em></p>
</div>
<div id="fixing-fragmented-iaps" class="section level1">
<h1>Fixing fragmented IAPs</h1>
<p>Many IAPs are of a ‘fragmented’ structure in the annotation: i.e., <code>LTR || internal</code> or solo <code>internal</code>s or <code>internal || LTR</code>. However, when looking at the genome browser, it is often apparent that these are actually fully structured IAPs which have been misannotated for various reasons:</p>
<center>
<div class="figure">
<img src="assets/example_broken_IAP.PNG" alt="An IAP containing a small simple repeat which has been split into four annotations of two different IAP types (d and EY5)" />
<p class="caption">An IAP containing a small simple repeat which has been split into four annotations of two different IAP types (<em>d</em> and <em>EY5</em>)</p>
</div>
</center>
<p>To fix these, I will look for at elements of the annotation of the three patterns above, and try to stitch them together. For example, if an <code>LTR || internal</code> element is followed by an <code>internal || LTR</code> element nearby (or even a solo LTR), I will combine them.</p>
<pre class="r"><code>get.basic.structure &lt;- function(reduced.s) {
  paste(
    runValue(Rle(c(&quot;LTR&quot;, &quot;internal&quot;)[
      1+as.numeric(grepl(&quot;.*[-int|_I]$&quot;,strsplit(reduced.s, &quot;\\|&quot;)[[1]]))
    ])),
    collapse=&quot;-&quot;
  )
}

analyse.structure &lt;- function(basic.s) {
  l &lt;- list(
    solo.LTR  = basic.s == &quot;LTR&quot;,
    LTR_int.5 = startsWith(basic.s, &quot;LTR-internal&quot;),
    int_LTR.3 = endsWith(basic.s, &quot;internal-LTR&quot;)
  )
  l$fully.structured = l$LTR_int.5 &amp; l$int_LTR.3
  
  l
}

mm10.IAP.reduced$basic.structure &lt;- sapply(
  mm10.IAP.reduced$reduced.structure,
  get.basic.structure,
  USE.NAMES = FALSE
)

mm10.IAP.reduced &lt;- cbind(mm10.IAP.reduced, analyse.structure(mm10.IAP.reduced$basic.structure))</code></pre>
<pre class="r"><code>#################
# iterate through incomplete IAPs (!solo &amp; !full) and try to join them with nearby elements
PARTIAL.JOIN.GAP &lt;- 2000 # max distance between partial elements to join them

incomplete.elements &lt;- with(mm10.IAP.reduced, element.ID[!solo.LTR &amp; !fully.structured])

mm10.IAP.reduced.old &lt;- mm10.IAP.reduced
mm10.IAP.gr$orig.element.ID &lt;- mm10.IAP.gr$element.ID

combine.elements &lt;- function(old.id, new.id) {
  cat(sprintf(&quot;Merging element %d into %d\n&quot;, old.id, new.id))
  # replace the element ID in the GRanges object
  mm10.IAP.gr[which(mm10.IAP.gr$element.ID == old.id)]$element.ID &lt;&lt;- new.id
  
  #cat(&quot;Here 1\n&quot;)
  # reclassify the new element structure
  new.elem.idx &lt;- which(mm10.IAP.reduced$element.ID==new.id)
  
  mm10.IAP.reduced[new.elem.idx,]$reduced.structure &lt;&lt;- get.reduced.structure(
    mm10.IAP.reduced[new.elem.idx,]$strand,
    mm10.IAP.gr[mm10.IAP.gr$element.ID == new.id]$repName
  )
  #cat(&quot;Here 2\n&quot;)
  
  mm10.IAP.reduced[new.elem.idx,]$basic.structure &lt;&lt;- get.basic.structure(mm10.IAP.reduced[new.elem.idx,]$reduced.structure)
  
  #cat(&quot;Here 3\n&quot;)
  new.analysis &lt;- analyse.structure(mm10.IAP.reduced[new.elem.idx,]$basic.structure)
  mm10.IAP.reduced[new.elem.idx,names(new.analysis)] &lt;&lt;- new.analysis
    
  #cat(&quot;Here 4\n&quot;)
  # remove old entry
  mm10.IAP.reduced &lt;&lt;- mm10.IAP.reduced[-which(mm10.IAP.reduced$element.ID==old.id),]
  #cat(&quot;Here 5\n&quot;)
}

get.single_elem.gr &lt;- function(elem.id) {
  elem.full.gr &lt;- mm10.IAP.gr[mm10.IAP.gr$element.ID == elem.id]
  
  elem.gr &lt;- elem.full.gr[1][,c()]
  end(elem.gr) &lt;- end(elem.full.gr[length(elem.full.gr)])
  
  elem.gr
}

for (inc.elem in incomplete.elements) {
  if (!inc.elem %in% mm10.IAP.reduced$element.ID) {
    # some elements may have been merged
    next
  }
  elem.gr &lt;- get.single_elem.gr(inc.elem)
  elem.strand.minus &lt;- as.character(strand(elem.gr)) == &quot;-&quot;
  
  # if no 5&#39; LTR -&gt; look upstream
  if (! mm10.IAP.reduced[mm10.IAP.reduced$element.ID==inc.elem,]$LTR_int.5) {
    flank.5 &lt;- flank(elem.gr, width=PARTIAL.JOIN.GAP, start=TRUE)
    flank.5.IAP &lt;- subsetByOverlaps(mm10.IAP.gr, flank.5, ignore.strand=FALSE)
    
    if (length(flank.5.IAP) &gt; 0) {
      # reorient results if on + strand
      if (!elem.strand.minus) flank.5.IAP &lt;- flank.5.IAP[length(flank.5.IAP):1]
      
      flank.5.elems &lt;- data.frame(element.ID = unique(flank.5.IAP$element.ID))
      flank.5.elems &lt;- left_join(flank.5.elems, mm10.IAP.reduced, by=&quot;element.ID&quot;)
      
      # try to join with neibouring elements, in the following order:
      # 1. complementary incomplete neighbouring IAPs
      # 2. solo LTRs
      # 3. full neighbouring IAPs
      if (any(with(flank.5.elems, LTR_int.5 &amp; !int_LTR.3))) {
        # join with first possible element? maybe make this more intellgient
        # e.g. checking they&#39;re roughly similar types? (e.g. comparing IAPs?)
        combine.elements(flank.5.elems[
                          with(flank.5.elems, LTR_int.5 &amp; !int_LTR.3),
                         ][1,]$element.ID,
                         inc.elem)
        elem.gr &lt;- get.single_elem.gr(inc.elem)
      } else if (any(flank.5.elems$solo.LTR)) {
        combine.elements(flank.5.elems[flank.5.elems$solo.LTR,][1,]$element.ID, inc.elem)
        elem.gr &lt;- get.single_elem.gr(inc.elem)
      } else if (any(flank.5.elems$LTR_int.5)) {
        combine.elements(flank.5.elems[flank.5.elems$LTR_int.5,][1,]$element.ID, inc.elem)
        elem.gr &lt;- get.single_elem.gr(inc.elem)
      }
    }
  }
  
  # if no 3&#39; LTR -&gt; look downstream
  if (! mm10.IAP.reduced[mm10.IAP.reduced$element.ID==inc.elem,]$int_LTR.3) {
    flank.3 &lt;- flank(elem.gr, width=PARTIAL.JOIN.GAP, start=FALSE)
    flank.3.IAP &lt;- subsetByOverlaps(mm10.IAP.gr, flank.3, ignore.strand=FALSE)
    
    if (length(flank.3.IAP) &gt; 0) {
      # reorient results if on - strand
      if (elem.strand.minus) flank.3.IAP &lt;- flank.3.IAP[length(flank.3.IAP):1]
      
      flank.3.elems &lt;- data.frame(element.ID = unique(flank.3.IAP$element.ID))
      flank.3.elems &lt;- left_join(flank.3.elems, mm10.IAP.reduced, by=&quot;element.ID&quot;)
      
      # try to join with neibouring elements, in the following order:
      # 1. complementary incomplete neighbouring IAPs
      # 2. solo LTRs
      # 3. full neighbouring IAPs
      if (any(with(flank.3.elems, int_LTR.3 &amp; !LTR_int.5))) {
        # join with first possible element? maybe make this more intellgient
        # e.g. checking they&#39;re roughly similar types? (e.g. comparing IAPs?)
        combine.elements(flank.3.elems[
                          with(flank.3.elems, int_LTR.3 &amp; !LTR_int.5),
                         ][1,]$element.ID,
                         inc.elem)
        elem.gr &lt;- get.single_elem.gr(inc.elem)
      } else if (any(flank.3.elems$solo.LTR)) {
        combine.elements(flank.3.elems[flank.3.elems$solo.LTR,][1,]$element.ID, inc.elem)
        elem.gr &lt;- get.single_elem.gr(inc.elem)
      } else if (any(flank.3.elems$int_LTR.3)) {
        combine.elements(flank.3.elems[flank.3.elems$int_LTR.3,][1,]$element.ID, inc.elem)
        elem.gr &lt;- get.single_elem.gr(inc.elem)
      }
    }
  }
}

mm10.IAP.mended &lt;- distinct(as.data.frame(mcols(mm10.IAP.gr)[,c(&quot;orig.element.ID&quot;, &quot;element.ID&quot;)]))</code></pre>
<p>This process resulted in 2387 elements being combined with other elements, and increased the number of fully-structured IAPs from 2740 to 2740. <em>fix this</em></p>
<p>An example of the mended vs old (RepeatMasker) annotation is shown below.</p>
<pre class="r"><code>plot.elem &lt;- function(elem.id) {
  elem.df &lt;- mm10.IAP.gr[mm10.IAP.gr$element.ID %in% elem.id | mm10.IAP.gr$orig.element.ID %in% elem.id] %&gt;% as.data.frame()
  elem.df$IAP.type &lt;- sapply(as.character(elem.df$repName), function(x) c(&quot;LTR&quot;, &quot;internal&quot;)[
    1+as.numeric(grepl(&quot;.*[-int|_I]$&quot;,strsplit(x, &quot;\\|&quot;)[[1]]))
    ])
  N.elements &lt;- nrow(elem.df)
  elem.df &lt;- rbind(elem.df, elem.df)
  elem.df$source &lt;- &quot;Mended&quot;
  elem.df[1:N.elements,]$element.ID &lt;- elem.df[1:N.elements,]$orig.element.ID
  elem.df[1:N.elements,]$source &lt;- &quot;RepeatMasker&quot;
  elem.df$y &lt;- as.numeric(factor(as.character(elem.df$element.ID)))
  y.conversion &lt;- elem.df[,c(&quot;y&quot;, &quot;element.ID&quot;)] %&gt;% unique()
  
  plt &lt;-  ggplot(elem.df) +
    geom_rect(aes(xmin=start, xmax=end, ymin=y-0.4, ymax=y+0.4, fill=IAP.type)) +
    facet_grid(source ~ ., space = &quot;free_y&quot;, scales = &quot;free_y&quot;) +
    scale_x_continuous(labels=scales::comma_format()) +
    scale_y_continuous(breaks=y.conversion$y, labels=y.conversion$element.ID) +
    xlab(unique(elem.df$seqnames)) + ylab(&quot;RepeatMasker element ID&quot;) +
    guides(fill = guide_legend(title=NULL))
  
  #print(plt)
  plt
}

elems.to.plot &lt;- with(mm10.IAP.mended, unique(element.ID[element.ID != orig.element.ID]))

plot.elem(elems.to.plot[11])</code></pre>
<p><img src="figure/01.IAP_Annotations.Rmd/plot.old.vs.new-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>
<button type="button" class="btn btn-default btn-xs btn-workflowr btn-workflowr-fig" data-toggle="collapse" data-target="#fig-plot.old.vs.new-1">
Past versions of plot.old.vs.new-1.png
</button>
</p>
<div id="fig-plot.old.vs.new-1" class="collapse">
<div class="table-responsive">
<table class="table table-condensed table-hover">
<thead>
<tr>
<th>
Version
</th>
<th>
Author
</th>
<th>
Date
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
6b0583c
</td>
<td>
Noah Kessler
</td>
<td>
2020-05-11
</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre class="r"><code>mm10.IAP$orig.element.ID &lt;- mm10.IAP.gr$orig.element.ID
mm10.IAP$element.ID &lt;- mm10.IAP.gr$element.ID

write.table(mm10.IAP, file.path(annot_dir, &quot;mm10.IAP.mended.tsv&quot;), sep=&quot;\t&quot;, col.names=FALSE, quote=FALSE, row.names=FALSE)

mm10.IAP.gr$first.subelement &lt;- FALSE
mm10.IAP.gr[(mm10.IAP.gr %&gt;% as.data.frame() %&gt;%
               mutate(index=1:n()) %&gt;% group_by(element.ID) %&gt;%
               top_n(-1, start))$index
           ]$first.subelement &lt;- TRUE

mm10.IAP.gr$last.subelement &lt;- FALSE
mm10.IAP.gr[(mm10.IAP.gr %&gt;% as.data.frame() %&gt;%
               mutate(index=1:n()) %&gt;% group_by(element.ID) %&gt;%
               top_n(1, end))$index
           ]$last.subelement &lt;- TRUE
mcols(mm10.IAP.gr)[strand(mm10.IAP.gr)==&#39;-&#39;, c(&quot;first.subelement&quot;, &quot;last.subelement&quot;)] &lt;- mcols(mm10.IAP.gr)[strand(mm10.IAP.gr)==&#39;-&#39;, c(&quot;last.subelement&quot;, &quot;first.subelement&quot;)]

mm10.IAP.gr$is.LTR &lt;- !grepl(&quot;.*[-int|_I]$&quot;, mm10.IAP.gr$repName)
saveRDS(mm10.IAP.gr, file.path(&quot;data&quot;, &quot;R_objects&quot;, &quot;mm10.IAP.gr.RDS&quot;))</code></pre>
</div>
<div id="structure-of-mes" class="section level1">
<h1>Structure of MEs</h1>
<p>What kind of IAP element structure do we see at MEs? How does this compare with the whole genome and with false positives?</p>
<p>** Need to run next section; maybe in new file? either way absolute paths need to be fixed, and interpretation below checked **</p>
<pre class="r"><code>mm10.IAP.top_name.structure &lt;- mm10.IAP.gr %&gt;% as.data.frame() %&gt;%
  dplyr::select(element.ID, repName, is.LTR, width) %&gt;%
  group_by(element.ID, is.LTR, repName) %&gt;%
  summarize(total.bp=sum(width)) %&gt;%
  group_by(element.ID, is.LTR) %&gt;%
  filter(1:n()==1) %&gt;% 
  ungroup() %&gt;% # test
  arrange(element.ID, !is.LTR) %&gt;%
  group_by(element.ID) %&gt;%
  summarize(top.names=paste(repName, collapse=&quot; – &quot;))

mm10.IAP.reduced &lt;- left_join(mm10.IAP.reduced, mm10.IAP.top_name.structure, by=&quot;element.ID&quot;)
mm10.IAP.reduced$optimal.structure &lt;- with(mm10.IAP.reduced,
                                      ifelse(solo.LTR | fully.structured,
                                             top.names,
                                             reduced.structure))



ME.validation &lt;- read.table(&quot;/data/reference/ME/IAP_validation.July2019.tsv&quot;, sep=&quot;\t&quot;, header=TRUE, stringsAsFactors=FALSE)
ME.validation.gr &lt;- unlist(as(lapply(ME.validation$Coordinates, ucsc2gr), &quot;GRangesList&quot;))
ME.validation.gr$Category &lt;- ME.validation$Category

element_ID.ME &lt;- unique(subsetByOverlaps(mm10.IAP.gr, ME.validation.gr[ME.validation.gr$Category==&quot;True ME&quot;])$element.ID)
element_ID.TS &lt;- unique(subsetByOverlaps(mm10.IAP.gr, ME.validation.gr[ME.validation.gr$Category==&quot;Tissue-specific&quot;])$element.ID)
#FIX ME
element_ID.TS &lt;- setdiff(element_ID.TS, 3514893)
element_ID.FP &lt;- unique(subsetByOverlaps(mm10.IAP.gr, ME.validation.gr[ME.validation.gr$Category==&quot;False-positive&quot;])$element.ID)


mm10.IAP.optimal.counts &lt;- count.df(mm10.IAP.reduced, &quot;optimal.structure&quot;, &quot;Genome&quot;)
mm10.IAP.optimal.counts &lt;- left_join(mm10.IAP.optimal.counts, mm10.IAP.reduced[,c(&quot;optimal.structure&quot;, &quot;basic.structure&quot;)] %&gt;% distinct, by=&quot;optimal.structure&quot;)

mm10.IAP.optimal.counts$elem.class &lt;- &quot;Broken&quot;
mm10.IAP.optimal.counts[mm10.IAP.optimal.counts$basic.structure ==&quot;LTR&quot;,]$elem.class &lt;- &quot;Solo LTR&quot;
mm10.IAP.optimal.counts[grepl(&quot;^LTR-.*-LTR$&quot;,mm10.IAP.optimal.counts$basic.structure),]$elem.class &lt;- &quot;Fully-structured&quot;

mm10.IAP.optimal.counts$elem.class.2 &lt;- &quot;Solo LTR&quot;
mm10.IAP.optimal.counts[mm10.IAP.optimal.counts$elem.class!=&quot;Solo LTR&quot;,]$elem.class.2 &lt;- &quot;Fully-structured or Incomplete&quot;
                                     
mm10.IAP.optimal.counts &lt;- left_join(mm10.IAP.optimal.counts,
                                     count.df(mm10.IAP.reduced %&gt;% filter(element.ID %in% element_ID.ME), &quot;optimal.structure&quot;, &quot;Constitutive ME&quot;))
mm10.IAP.optimal.counts &lt;- left_join(mm10.IAP.optimal.counts,
                                     count.df(mm10.IAP.reduced %&gt;% filter(element.ID %in% element_ID.TS), &quot;optimal.structure&quot;, &quot;Tissue-Specific&quot;))

mm10.IAP.optimal.counts &lt;- mm10.IAP.optimal.counts %&gt;% arrange(desc(Genome))

mm10.IAP.optimal.counts.norm &lt;- mm10.IAP.optimal.counts %&gt;%
  mutate_if(is.numeric, function(x) x / max(x, na.rm=TRUE))
mm10.IAP.opt.cnt.plt.df &lt;- mm10.IAP.optimal.counts.norm %&gt;%
  mutate(order=1:n()) %&gt;%
  filter(!is.na(`Constitutive ME`) | !is.na(`Tissue-Specific`)) %&gt;%
  melt(id.vars=c(&quot;optimal.structure&quot;, &quot;order&quot;, &quot;basic.structure&quot;, &quot;elem.class&quot;, &quot;elem.class.2&quot;), variable.name=&quot;set&quot;, value.name=&quot;N&quot;) %&gt;%
  arrange(desc(order))

mm10.IAP.opt.cnt.plt.df[is.na(mm10.IAP.opt.cnt.plt.df)]&lt;- 0.001 # show something even if none
mm10.IAP.opt.cnt.plt.df[mm10.IAP.opt.cnt.plt.df$N &lt; 0.001] &lt;- 0.001
mm10.IAP.opt.cnt.plt.df$optimal.structure &lt;- gsub(&quot;\\|&quot;, &quot; || &quot;, gsub(&quot;IAP-?&quot;, &quot;&quot;, mm10.IAP.opt.cnt.plt.df$optimal.structure))
mm10.IAP.opt.cnt.plt.df$optimal.structure &lt;- factor(mm10.IAP.opt.cnt.plt.df$optimal.structure, levels=unique(mm10.IAP.opt.cnt.plt.df$optimal.structure))

group.colors &lt;- c(Genome = &quot;#444444&quot;, `Constitutive ME` = &quot;#1b9e77&quot;, `Tissue-Specific` = &quot;#d95f02&quot;)

ggplot(mm10.IAP.opt.cnt.plt.df, aes(x=optimal.structure)) +
  geom_bar(aes(y=N, fill=forcats::fct_rev(set)), stat=&quot;identity&quot;, position=&quot;dodge&quot;) +
  coord_flip() + theme_bw(base_size=14) +
  ylab(&quot;Relative frequency of element structure&quot;) + xlab(NULL) +
  theme(panel.grid.major.y = element_blank(), axis.text.y = element_text(face=&quot;bold&quot;)) +
  scale_y_continuous(expand=c(0, 0.01)) +
  scale_fill_manual(guide=guide_legend(reverse=TRUE, title=NULL), values=group.colors) +
  facet_grid(vars(elem.class.2),  scales = &quot;free_y&quot;, space=&quot;free_y&quot;) #+
  #ggtitle(&quot;Distribution of IAP element structure&quot;)

### for pub
ggplot(mm10.IAP.opt.cnt.plt.df, aes(x=optimal.structure)) +
  geom_bar(aes(y=N, fill=forcats::fct_rev(set)), stat=&quot;identity&quot;, position=&quot;dodge&quot;) +
  coord_flip() + theme_bw(base_size=22) +
  ylab(&quot;Relative frequency of element structure&quot;) + xlab(NULL) +
  theme(panel.grid.major.y = element_blank(),
        axis.text.y = element_text(face=&quot;bold&quot;, size=16),
        axis.ticks.y = element_line(color=&quot;black&quot;, size=10),
        axis.ticks.length.y = unit(0.03, &quot;cm&quot;),
        legend.position = c(0.825, 0.075),
        legend.background=element_rect(color=&quot;black&quot;),
        legend.title=element_blank(),
        legend.margin=margin(0, 0.25, 0.25, 0.2, unit=&#39;cm&#39;)) +
  scale_y_continuous(expand=c(0, 0.01)) +
  scale_fill_manual(guide=guide_legend(reverse=TRUE), values=group.colors) +
  facet_grid(vars(elem.class.2),  scales = &quot;free_y&quot;, space=&quot;free_y&quot;) #+
###










mm10.IAP.reduced.counts &lt;- left_join(mm10.IAP.reduced.counts, mm10.IAP.reduced[,c(&quot;reduced.structure&quot;, &quot;basic.structure&quot;)] %&gt;% distinct,
                                     by=&quot;reduced.structure&quot;)

mm10.IAP.reduced.counts$class &lt;- &quot;Broken&quot;
mm10.IAP.reduced.counts[mm10.IAP.reduced.counts$basic.structure ==&quot;LTR&quot;,]$class &lt;- &quot;Solo LTR&quot;
mm10.IAP.reduced.counts[grepl(&quot;^LTR-.*-LTR$&quot;,mm10.IAP.reduced.counts$basic.structure),]$class &lt;- &quot;Fully-structured&quot;

mm10.IAP.reduced.counts &lt;- left_join(mm10.IAP.reduced.counts,
                                     count.df(mm10.IAP.reduced %&gt;% filter(element.ID %in% element_ID.ME), &quot;reduced.structure&quot;, &quot;True ME&quot;))
mm10.IAP.basic.counts &lt;- left_join(mm10.IAP.basic.counts,
                                     count.df(mm10.IAP.reduced %&gt;% filter(element.ID %in% element_ID.ME), &quot;basic.structure&quot;, &quot;True ME&quot;))
mm10.IAP.reduced.counts &lt;- left_join(mm10.IAP.reduced.counts,
                                     count.df(mm10.IAP.reduced %&gt;% filter(element.ID %in% element_ID.TS), &quot;reduced.structure&quot;, &quot;Tissue-Specific&quot;))
mm10.IAP.basic.counts &lt;- left_join(mm10.IAP.basic.counts,
                                     count.df(mm10.IAP.reduced %&gt;% filter(element.ID %in% element_ID.TS), &quot;basic.structure&quot;, &quot;Tissue-Specific&quot;))
mm10.IAP.reduced.counts &lt;- left_join(mm10.IAP.reduced.counts,
                                     count.df(mm10.IAP.reduced %&gt;% filter(element.ID %in% element_ID.FP), &quot;reduced.structure&quot;, &quot;False Positive&quot;))
mm10.IAP.basic.counts &lt;- left_join(mm10.IAP.basic.counts,
                                     count.df(mm10.IAP.reduced %&gt;% filter(element.ID %in% element_ID.FP), &quot;basic.structure&quot;, &quot;False Positive&quot;))

mm10.IAP.reduced.counts &lt;- mm10.IAP.reduced.counts %&gt;% arrange(desc(Genome))
mm10.IAP.basic.counts &lt;- mm10.IAP.basic.counts %&gt;% arrange(desc(Genome))

mm10.IAP.reduced.counts.norm &lt;- mm10.IAP.reduced.counts %&gt;%
  mutate_if(is.numeric, function(x) x / max(x, na.rm=TRUE))
mm10.IAP.basic.counts.norm &lt;- mm10.IAP.basic.counts %&gt;%
  mutate_if(is.numeric, function(x) x / max(x, na.rm=TRUE))

mm10.IAP.red.cnt.plt.df &lt;- mm10.IAP.reduced.counts.norm %&gt;%
  mutate(order=1:n()) %&gt;%
  filter(!is.na(`True ME`) | !is.na(`False Positive` | !is.na(`Tissue-Specific`))) %&gt;%
  melt(id.vars=c(&quot;reduced.structure&quot;, &quot;order&quot;, &quot;basic.structure&quot;, &quot;class&quot;), variable.name=&quot;set&quot;, value.name=&quot;N&quot;) %&gt;%
  arrange(desc(order))
mm10.IAP.red.cnt.plt.df[is.na(mm10.IAP.red.cnt.plt.df)]&lt;- 0.001 # show something even if none
mm10.IAP.red.cnt.plt.df[mm10.IAP.red.cnt.plt.df$N &lt; 0.001] &lt;- 0.001
mm10.IAP.red.cnt.plt.df$reduced.structure &lt;- gsub(&quot;\\|&quot;, &quot; || &quot;, gsub(&quot;IAP-?&quot;, &quot;&quot;, mm10.IAP.red.cnt.plt.df$reduced.structure))
mm10.IAP.red.cnt.plt.df$reduced.structure &lt;- factor(mm10.IAP.red.cnt.plt.df$reduced.structure, levels=unique(mm10.IAP.red.cnt.plt.df$reduced.structure))

structs.to.keep.no_fp &lt;-mm10.IAP.red.cnt.plt.df %&gt;%
    filter(set != &quot;False Positive&quot; &amp; set != &quot;Genome&quot;) %&gt;%
    group_by(reduced.structure) %&gt;% 
    filter(max(N) &gt; 0.001) %&gt;%
    dplyr::select(reduced.structure) %&gt;%
  distinct() %&gt;%
  pull(reduced.structure)

mm10.IAP.red.cnt.no_fp.plt.df &lt;- mm10.IAP.red.cnt.plt.df %&gt;%
  filter(set != &quot;False Positive&quot; &amp; reduced.structure %in% structs.to.keep.no_fp)

mm10.IAP.red.cnt.plt.df$shading &lt;- rep_len(rep(c(&quot;A&quot;, &quot;B&quot;), each=4), nrow(mm10.IAP.red.cnt.plt.df))

mm10.IAP.bas.cnt.plt.df &lt;- cbind(mm10.IAP.basic.counts.norm, order=1:nrow(mm10.IAP.basic.counts.norm)) %&gt;% filter(!is.na(`True ME`) | !is.na(`False Positive` | !is.na(`Tissue-Specific`))) %&gt;%
  melt(id.vars=c(&quot;basic.structure&quot;, &quot;order&quot;), variable.name=&quot;set&quot;, value.name=&quot;N&quot;) %&gt;%
  arrange(desc(order))
mm10.IAP.bas.cnt.plt.df[is.na(mm10.IAP.bas.cnt.plt.df)]&lt;- 0.001 # show something even if none
mm10.IAP.bas.cnt.plt.df$basic.structure &lt;- gsub(&quot;\\|&quot;, &quot; || &quot;, gsub(&quot;IAP-?&quot;, &quot;&quot;, mm10.IAP.bas.cnt.plt.df$basic.structure))
mm10.IAP.bas.cnt.plt.df$basic.structure &lt;- factor(mm10.IAP.bas.cnt.plt.df$basic.structure, levels=unique(mm10.IAP.bas.cnt.plt.df$basic.structure))

ggplot(mm10.IAP.red.cnt.no_fp.plt.df, aes(x=reduced.structure)) +
    geom_bar(aes(y=N, fill=forcats::fct_rev(set)), stat=&quot;identity&quot;, position=&quot;dodge&quot;) +
    #geom_ribbon(aes(ymin = -Inf, ymax = Inf, fill = shading, group = shading), alpha = .2) +
    coord_flip() + theme_bw(base_size=14) +
  ylab(&quot;Relative frequency of element structure&quot;) + xlab(&quot;Element structure&quot;) +
  theme(panel.grid.major.y = element_blank(), axis.text.y = element_text(face=&quot;bold&quot;)) +
  scale_y_continuous(expand=c(0, 0.01)) +
  scale_fill_discrete(guide=guide_legend(reverse=TRUE, title=NULL)) +
  facet_wrap(vars(class), ncol=1, scales = &quot;free&quot;) +
  ggtitle(&quot;Distribution of IAP element structure&quot;)

ggplot(mm10.IAP.bas.cnt.plt.df, aes(x=basic.structure)) +
    geom_bar(aes(y=N, fill=forcats::fct_rev(set)), stat=&quot;identity&quot;, position=&quot;dodge&quot;) +
    coord_flip() + theme_bw() +
  ylab(&quot;Relative frequency of element structure&quot;) + xlab(&quot;Element structure&quot;) +
  theme(panel.grid.major.y = element_blank(), axis.text.y = element_text(face=&quot;bold&quot;)) +
  scale_y_continuous(expand=c(0, 0.01)) +
  scale_fill_discrete(guide=guide_legend(reverse=TRUE, title=NULL)) +
  ggtitle(&quot;Distribution of IAP element structure&quot;)</code></pre>
<br>
<p>
<button type="button" class="btn btn-default btn-workflowr btn-workflowr-sessioninfo" data-toggle="collapse" data-target="#workflowr-sessioninfo" style="display: block;">
<span class="glyphicon glyphicon-wrench" aria-hidden="true"></span> Session information
</button>
</p>
<div id="workflowr-sessioninfo" class="collapse">
<pre class="r"><code>sessionInfo()</code></pre>
</div>
</div>


<!-- Adjust MathJax settings so that all math formulae are shown using
TeX fonts only; see
http://docs.mathjax.org/en/latest/configuration.html.  This will make
the presentation more consistent at the cost of the webpage sometimes
taking slightly longer to load. Note that this only works because the
footer is added to webpages before the MathJax javascript. -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
